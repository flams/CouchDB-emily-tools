/*
 https://github.com/flams/CouchDB-emily-tools
 The MIT License (MIT)
 Copyright (c) 2012 Olivier Scherrer <pode.fr@gmail.com>
*/
define("CouchDBBase",["Store","Tools","Promise"],function(j,h,f){function e(){var e=null,c="CouchDB",a=null,b,d=new f;this.setPromise=function(a){return typeof a=="object"&&typeof a.fulfill=="function"&&typeof a.reject=="function"&&typeof a.then=="function"?(d=a,true):false};this.getPromise=function(){return d};this.getStateMachine=function(){return e};this.setStateMachine=function(a){return typeof a=="object"&&typeof a.event=="function"?(e=a,true):false};this.getTransport=function(){return a};this.setTransport=
function(b){return typeof b=="object"&&typeof b.request=="function"&&typeof b.listen=="function"?(a=b,true):false};this.getHandlerName=function(){return c};this.setHandlerName=function(a){return typeof a=="string"?(c=a,true):false};this.sync=function(){d=new f;return(b=this.setSyncInfo.apply(this,arguments))?(e.event("sync"),d):false};this.unsync=function(){return e.event("unsync")};this.getSyncInfo=function(){return b};this.onSync=function(){};this.onListen=function(){};this.onUnsync=function(){this.stopListening&&
this.stopListening();delete this.stopListening};this.unsync=function(){e.event("unsync")};this.onChange=function(){};this.onAdd=function(){};this.onRemove=function(){};this.setSyncInfo=function(a){return b=a}}return function(f){e.prototype=new j(f);return new e}});
define("CouchDBDocument",["Store","CouchDBBase","Tools","Promise","StateMachine"],function(j,h,f,e,k){function c(){this.setSyncInfo=function(a,b,d){return typeof a=="string"&&typeof b=="string"?!d||typeof d=="object"?{database:a,document:b,query:d||{}}:false:false};this.onSync=function(){var a=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+a.database+"/"+a.document,query:a.query},function(a){a=JSON.parse(a);a._id&&(this.reset(a),this.getStateMachine().event("listen"));
this.getPromise().fulfill(a)},this)};this.onListen=function(){var a=this.getSyncInfo();this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+a.database+"/_changes",query:{feed:"continuous",heartbeat:2E4,descending:true}},function(b){if(b=="\n")return false;b=JSON.parse(b);b.id==a.document&&b.changes.pop().rev!=this.get("_rev")&&(b.deleted?this.getStateMachine().event("remove"):this.getStateMachine().event("change"))},this)};this.onChange=function(){var a=this.getSyncInfo();
this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+a.database+"/"+a.document},function(a){this.reset(JSON.parse(a))},this)};this.onRemove=function(){this.reset({})};this.upload=function(){var a=new e;return this.getSyncInfo().document?(this.getStateMachine().event("upload",a),a):false};this.remove=function(){this.getSyncInfo();var a=new e;this.getStateMachine().event("removeFromDatabase",a);return a};this.databaseCreate=function(a){var b=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),
{method:"PUT",path:"/"+b.database+"/"+b.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(b){b=JSON.parse(b);b.ok?(this.set("_rev",b.rev),this.set("_id",b.id),this.getStateMachine().event("listen"),a.fulfill(b)):a.reject(b)},this)};this.databaseUpdate=function(a){var b=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"PUT",path:"/"+b.database+"/"+b.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(b){b=JSON.parse(b);
b.ok?(this.set("_rev",b.rev),a.fulfill(b)):a.reject(b)},this)};this.databaseRemove=function(a){var b=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"DELETE",path:"/"+b.database+"/"+b.document,query:{rev:this.get("_rev")}},function(b){b=JSON.parse(b);b.ok?a.fulfill(b):a.reject(b)})};this.setStateMachine(new k("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"],["upload",this.databaseCreate,
this]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this],["removeFromDatabase",this.databaseRemove,this]]}))}return function(a){c.prototype=new h(a);return new c}});
define("CouchDBView",["Store","CouchDBBase","Tools","StateMachine"],function(j,h,f,e){function k(){this.setSyncInfo=function(c,a,b,d){return typeof c=="string"&&typeof a=="string"&&typeof b=="string"?!d||typeof d=="object"?{database:c,design:a,view:b,query:d||{}}:false:false};this.onSync=function(){var c=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+c.database+"/_design/"+c.design+"/"+c.view,query:c.query},function(a){var b=JSON.parse(a);if(b.rows){this.reset(b.rows);
this.getPromise().fulfill(this);if(typeof b.total_rows=="undefined")c.reducedView=true;this.getStateMachine().event("listen")}else throw Error("CouchDBStore ["+c.database+", "+c.design+", "+c.view+"].sync() failed: "+a);},this)};this.onListen=function(){var c=this.getSyncInfo();f.mixin({feed:"continuous",heartbeat:2E4,descending:true},c.query);this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+c.database+"/_changes",query:c.query},function(a){if(a=="\n")return false;var a=
JSON.parse(a),b;b=c.reducedView?"updateReduced":a.deleted?"delete":a.changes&&a.changes[0].rev.search("1-")==0?"add":"change";this.getStateMachine().event(b,a.id)},this)};this.onChange=function(c){var a=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){a=JSON.parse(a);a.rows.length==this.getNbItems()?a.rows.some(function(a,b){a.id==c&&this.set(b,a)},this):this.evenDocsInStore.call(this,
a.rows,c)},this)};this.evenDocsInStore=function(c,a){var b=this.getNbItems();c.length<b?this.loop(function(b,c){b.id==a&&this.del(c)},this):c.length>b&&c.some(function(b,c){if(b.id==a)return this.alter("splice",c,0,b)},this)};this.onAdd=function(c){var a=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){JSON.parse(a).rows.some(function(a,b){a.id==c&&this.alter("splice",b,0,a)},this)},this)};
this.onRemove=function(c){this.loop(function(a,b){a.id==c&&this.del(b)},this)};this.updateReduced=function(){var c=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+c.database+"/_design/"+c.design+"/"+c.view,query:c.query},function(a){this.set(0,JSON.parse(a).rows[0])},this)};this.setStateMachine(new e("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["unsync",
this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["updateReduced",this.updateReduced,this]]}))}return function(c){k.prototype=new h(c);return new k}});
define("CouchDBBulkDocuments",["Store","CouchDBBase","Tools","Promise","StateMachine"],function(j,h,f,e,k){function c(){this.setSyncInfo=function(a,b){if(typeof a=="string"&&typeof b=="object"){var c={database:a,query:b||{}};if(Array.isArray(c.query.keys))c.keys=c.query.keys,delete c.query.keys;return c}else return false};this.onSync=function(){var a=this.getSyncInfo(),b={path:"/"+a.database+"/_all_docs",query:a.query},c;Array.isArray(a.keys)?(b.method="POST",b.data=JSON.stringify({keys:a.keys}),
b.headers={"Content-Type":"application/json"},c=b.data):(b.method="GET",c=JSON.stringify(a.query));a.query.include_docs=true;this.getTransport().request(this.getHandlerName(),b,function(b){var i=JSON.parse(b);if(i.rows)this.reset(i.rows),this.getPromise().fulfill(this),this.getStateMachine().event("listen");else throw Error('CouchDBBulkDocuments.sync("'+a.database+'", '+c+") failed: "+b);},this)};this.onListen=function(){var a=this.getSyncInfo();f.mixin({feed:"continuous",heartbeat:2E4,descending:true,
include_docs:true},a.query);this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+a.database+"/_changes",query:a.query},function(a){if(a=="\n")return false;var a=JSON.parse(a),c;c=a.changes[0].rev.search("1-")==0?"add":a.deleted?"remove":"change";this.getStateMachine().event(c,a.id,a.doc)},this)};this.onAdd=function(a){var b=this.getSyncInfo();if(b.query.startkey||b.query.endkey)b.query.include_docs=true,b.query.update_seq=true,this.getTransport().request(this.getHandlerName(),
{method:"GET",path:"/"+b.database+"/_all_docs",query:b.query},function(b){JSON.parse(b).rows.forEach(function(b,c){b.id==a&&this.alter("splice",c,0,b.doc)},this)},this);else return false};this.onChange=function(a,b){this.loop(function(c,e){c.id==a&&this.set(e,b)},this)};this.onRemove=function(a){this.loop(function(b,c){b.id==a&&this.del(c)},this)};this.databaseUpdate=function(a){var b=[],c=this.getSyncInfo();this.loop(function(a){b.push(a.doc)});this.getTransport().request(this.getHandlerName(),{method:"POST",
path:"/"+c.database+"/_bulk_docs",headers:{"Content-Type":"application/json"},data:JSON.stringify({docs:b})},function(b){a.fulfill(JSON.parse(b))})};this.upload=function(){var a=new e;this.getStateMachine().event("upload",a);return a};this.setStateMachine(new k("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",
this.onAdd,this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this]]}))}return function(a){c.prototype=new h(a);return new c}});
define("CouchDBStore",["Store","StateMachine","Tools","Promise"],function(j,h,f,e){function k(){var c=null,a={},b=new e,d={getView:function(){a.query=a.query||{};c.request("CouchDB",{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(c){var l=JSON.parse(c);if(l.rows)this.reset(l.rows),b.fulfill(this),typeof l.total_rows=="undefined"&&this.setReducedViewInfo(true),g.event("subscribeToViewChanges");else throw Error("CouchDBStore ["+a.database+", "+a.design+", "+
a.view+"].sync() failed: "+c);},this)},getDocument:function(){c.request("CouchDB",{method:"GET",path:"/"+a.database+"/"+a.document,query:a.query},function(a){var c=JSON.parse(a);c._id?(this.reset(c),b.fulfill(this),g.event("subscribeToDocumentChanges")):b.reject(a)},this)},getBulkDocuments:function(){var i={path:"/"+a.database+"/_all_docs",query:a.query},l;a.keys instanceof Array?(i.method="POST",i.data=JSON.stringify({keys:a.keys}),i.headers={"Content-Type":"application/json"},l=i.data):(i.method=
"GET",l=JSON.stringify(a.query));a.query.include_docs=true;c.request("CouchDB",i,function(c){var i=JSON.parse(c);if(i.rows)this.reset(i.rows),b.fulfill(this),g.event("subscribeToBulkChanges");else throw Error('CouchDBStore.sync("'+a.database+'", '+l+") failed: "+c);},this)},createDocument:function(b){c.request("CouchDB",{method:"PUT",path:"/"+a.database+"/"+a.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(a){a=JSON.parse(a);a.ok?(b.fulfill(a),g.event("subscribeToDocumentChanges")):
b.reject(a)})},subscribeToViewChanges:function(){f.mixin({feed:"continuous",heartbeat:2E4,descending:true},a.query);this.stopListening=c.listen("CouchDB",{path:"/"+a.database+"/_changes",query:a.query},function(b){if(b=="\n")return false;var b=JSON.parse(b),c;c=a.reducedView?"updateReduced":b.deleted?"delete":b.changes&&b.changes[0].rev.search("1-")==0?"add":"change";g.event(c,b.id)},this)},subscribeToDocumentChanges:function(){this.stopListening=c.listen("CouchDB",{path:"/"+a.database+"/_changes",
query:{feed:"continuous",heartbeat:2E4,descending:true}},function(b){if(b=="\n")return false;b=JSON.parse(b);b.id==a.document&&b.changes.pop().rev!=this.get("_rev")&&(b.deleted?g.event("deleteDoc"):g.event("updateDoc"))},this)},subscribeToBulkChanges:function(){f.mixin({feed:"continuous",heartbeat:2E4,descending:true,include_docs:true},a.query);this.stopListening=c.listen("CouchDB",{path:"/"+a.database+"/_changes",query:a.query},function(a){if(a=="\n")return false;var a=JSON.parse(a),b;b=a.changes[0].rev.search("1-")==
0?"bulkAdd":a.deleted?"delete":"bulkChange";g.event(b,a.id,a.doc)},this)},updateDocInStore:function(b){c.request("CouchDB",{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){a=JSON.parse(a);a.rows.length==this.getNbItems()?a.rows.some(function(a,c){a.id==b&&this.set(c,a)},this):this.actions.evenDocsInStore.call(this,a.rows,b)},this)},evenDocsInStore:function(a,b){var c=this.getNbItems();a.length<c?this.loop(function(a,c){a.id==b&&this.del(c)},this):a.length>
c&&a.some(function(a,c){if(a.id==b)return this.alter("splice",c,0,a)},this)},addBulkDocInStore:function(b){if(a.query.startkey||a.query.endkey)a.query.include_docs=true,a.query.update_seq=true,c.request("CouchDB",{method:"GET",path:"/"+a.database+"/_all_docs",query:a.query},function(a){JSON.parse(a).rows.forEach(function(a,c){a.id==b&&this.alter("splice",c,0,a.doc)},this)},this);else return false},updateBulkDocInStore:function(a,b){this.loop(function(c,d){c.id==a&&this.set(d,b)},this)},removeDocInStore:function(a){this.loop(function(b,
c){b.id==a&&this.del(c)},this)},addDocInStore:function(b){c.request("CouchDB",{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){JSON.parse(a).rows.some(function(a,c){a.id==b&&this.alter("splice",c,0,a)},this)},this)},updateReduced:function(){c.request("CouchDB",{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){this.set(0,JSON.parse(a).rows[0])},this)},updateDoc:function(){c.request("CouchDB",{method:"GET",path:"/"+
a.database+"/"+a.document},function(a){this.reset(JSON.parse(a))},this)},deleteDoc:function(){this.reset({})},updateDatabase:function(b){c.request("CouchDB",{method:"PUT",path:"/"+a.database+"/"+a.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(a){a=JSON.parse(a);a.ok?(this.set("_rev",a.rev),b.fulfill(a)):b.reject(a)},this)},updateDatabaseWithBulkDoc:function(b){var d=[];this.loop(function(a){d.push(a.doc)});c.request("CouchDB",{method:"POST",path:"/"+a.database+
"/_bulk_docs",headers:{"Content-Type":"application/json"},data:JSON.stringify({docs:d})},function(a){b.fulfill(JSON.parse(a))})},removeFromDatabase:function(){c.request("CouchDB",{method:"DELETE",path:"/"+a.database+"/"+a.document,query:{rev:this.get("_rev")}})},unsync:function(){this.stopListening();delete this.stopListening}},g=new h("Unsynched",{Unsynched:[["getView",d.getView,this,"Synched"],["getDocument",d.getDocument,this,"Synched"],["getBulkDocuments",d.getBulkDocuments,this,"Synched"]],Synched:[["updateDatabase",
d.createDocument,this],["subscribeToViewChanges",d.subscribeToViewChanges,this,"Listening"],["subscribeToDocumentChanges",d.subscribeToDocumentChanges,this,"Listening"],["subscribeToBulkChanges",d.subscribeToBulkChanges,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["change",d.updateDocInStore,this],["bulkAdd",d.addBulkDocInStore,this],["bulkChange",d.updateBulkDocInStore,this],["delete",d.removeDocInStore,this],["add",d.addDocInStore,this],["updateReduced",d.updateReduced,this],
["updateDoc",d.updateDoc,this],["deleteDoc",d.deleteDoc,this],["updateDatabase",d.updateDatabase,this],["updateDatabaseWithBulkDoc",d.updateDatabaseWithBulkDoc,this],["removeFromDatabase",d.removeFromDatabase,this],["unsync",d.unsync,this,"Unsynched"]]});this.sync=function(a,c,d,f){b=new e;if(typeof a=="string"&&typeof c=="string"&&typeof d=="string")return this.setSyncInfo(a,c,d,f),g.event("getView"),b;else if(typeof a=="string"&&typeof c=="string"&&typeof d!="string")return this.setSyncInfo(a,c,
d),g.event("getDocument"),b;else if(typeof a=="string"&&c instanceof Object)return this.setSyncInfo(a,c),g.event("getBulkDocuments"),b;return false};this.setSyncInfo=function(b,c,d,e){this.clearSyncInfo();if(typeof b=="string"&&typeof c=="string"&&typeof d=="string")return a.database=b,a.design=c,a.view=d,a.query=e,true;else if(typeof b=="string"&&typeof c=="string"&&typeof d!="string")return a.database=b,a.document=c,a.query=d,true;else if(typeof b=="string"&&c instanceof Object){a.database=b;a.query=
c;if(a.query.keys instanceof Array)a.keys=a.query.keys,delete a.query.keys;return true}return false};this.clearSyncInfo=function(){a={};return true};this.setReducedViewInfo=function(b){return typeof b=="boolean"?(a.reducedView=b,true):false};this.getSyncInfo=function(){return a};this.unsync=function(){return g.event("unsync")};this.upload=function(){var b=new e;if(a.document)return g.event("updateDatabase",b),b;else if(!a.view)return g.event("updateDatabaseWithBulkDoc",b),b;return false};this.remove=
function(){return a.document?g.event("removeFromDatabase"):false};this.setTransport=function(a){return a&&typeof a.listen=="function"&&typeof a.request=="function"?(c=a,true):false};this.getStateMachine=function(){return g};this.getTransport=function(){return c};this.actions=d}return function(c){k.prototype=new j(c);return new k}});
define("CouchDBUser",["CouchDBStore","Promise"],function(j,h){function f(){var e="_users",f="org.couchdb.user:";this.getUserDB=function(){return e};this.setUserDB=function(c){return c?(e=c,true):false};this.getIdPrefix=function(){return f};this.setIdPrefix=function(c){return c?(f=c,true):false};this.setId=function(c){return c?(this.set("_id",f+c),true):false};this.getId=function(){return this.get("_id")};this.load=function(c){return this.sync(e,f+c)};this.login=function(){var c=new h,a=this.get("name"),
b=this.get("password");a&&typeof a=="string"&&typeof b=="string"?this.getTransport().request("CouchDB",{method:"GET",path:"/_users/org.couchdb.user:"+a,auth:a+":"+b},c.fulfill,c):c.reject({error:"name & password must be strings"});return c};this.create=function(){var c=new h;this.get("type")||this.set("type","user");this.get("roles")||this.set("roles",[]);this.load(this.get("name")).then(function(){c.reject({error:"Failed to create user. The user already exists"})},function(){this.upload().then(function(a){c.fulfill(a)},
function(a){c.reject(a)})},this);return c}}return function(){f.prototype=new j;return new f}});define("CouchDBSecurity",["CouchDBStore"],function(j){function h(){var f="_security";this.setName=function(e){return e?(f=e,true):false};this.getName=function(){return f};this.load=function(e){return this.sync(e,f)}}return function(){h.prototype=new j;return new h}});
