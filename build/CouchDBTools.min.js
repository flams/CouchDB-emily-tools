/*
 https://github.com/flams/CouchDB-emily-tools
 The MIT License (MIT)
 Copyright (c) 2012 Olivier Scherrer <pode.fr@gmail.com>
*/
define("CouchDBBase",["Store","Tools","Promise"],function(i,g,f){function e(){var d=null,c="CouchDB",a=null,b,h=new f;this.setPromise=function(a){return typeof a=="object"&&typeof a.fulfill=="function"&&typeof a.reject=="function"&&typeof a.then=="function"?(h=a,true):false};this.getPromise=function(){return h};this.getStateMachine=function(){return d};this.setStateMachine=function(a){return typeof a=="object"&&typeof a.event=="function"?(d=a,true):false};this.getTransport=function(){return a};this.setTransport=
function(b){return typeof b=="object"&&typeof b.request=="function"&&typeof b.listen=="function"?(a=b,true):false};this.getHandlerName=function(){return c};this.setHandlerName=function(a){return typeof a=="string"?(c=a,true):false};this.sync=function(){h=new f;return(b=this.setSyncInfo.apply(this,arguments))?(d.event("sync"),h):false};this.unsync=function(){return d.event("unsync")};this.getSyncInfo=function(){return b};this.onSync=function(){};this.onListen=function(){};this.onUnsync=function(){this.stopListening&&
this.stopListening();delete this.stopListening};this.unsync=function(){d.event("unsync")};this.onChange=function(){};this.onAdd=function(){};this.onRemove=function(){};this.setSyncInfo=function(a){return b=a}}return function(d){e.prototype=new i(d);return new e}});
define("CouchDBDocument",["Store","CouchDBBase","Tools","Promise","StateMachine"],function(i,g,f,e,d){function c(){this.setSyncInfo=function(a,b,h){return typeof a=="string"&&typeof b=="string"?!h||typeof h=="object"?{database:a,document:b,query:h||{}}:false:false};this.onSync=function(){var a=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+a.database+"/"+a.document,query:a.query},function(a){a=JSON.parse(a);a._id&&(this.reset(a),this.getStateMachine().event("listen"));
this.getPromise().fulfill(a)},this)};this.onListen=function(){var a=this.getSyncInfo();this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+a.database+"/_changes",query:{feed:"continuous",heartbeat:2E4,descending:true}},function(b){if(b=="\n")return false;b=JSON.parse(b);b.id==a.document&&b.changes.pop().rev!=this.get("_rev")&&(b.deleted?this.getStateMachine().event("remove"):this.getStateMachine().event("change"))},this)};this.onChange=function(){var a=this.getSyncInfo();
this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+a.database+"/"+a.document},function(a){this.reset(JSON.parse(a))},this)};this.onRemove=function(){this.reset({})};this.upload=function(){var a=new e;return this.getSyncInfo().document?(this.getStateMachine().event("upload",a),a):false};this.remove=function(){this.getSyncInfo();var a=new e;this.getStateMachine().event("removeFromDatabase",a);return a};this.databaseCreate=function(a){var b=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),
{method:"PUT",path:"/"+b.database+"/"+b.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(b){b=JSON.parse(b);b.ok?(this.set("_rev",b.rev),this.set("_id",b.id),this.getStateMachine().event("listen"),a.fulfill(b)):a.reject(b)},this)};this.databaseUpdate=function(a){var b=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"PUT",path:"/"+b.database+"/"+b.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(b){b=JSON.parse(b);
b.ok?(this.set("_rev",b.rev),a.fulfill(b)):a.reject(b)},this)};this.databaseRemove=function(a){var b=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"DELETE",path:"/"+b.database+"/"+b.document,query:{rev:this.get("_rev")}},function(b){b=JSON.parse(b);b.ok?a.fulfill(b):a.reject(b)})};this.setStateMachine(new d("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"],["upload",this.databaseCreate,
this]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this],["removeFromDatabase",this.databaseRemove,this]]}))}return function(a){c.prototype=new g(a);return new c}});
define("CouchDBView",["Store","CouchDBBase","Tools","StateMachine"],function(i,g,f,e){function d(){this.setSyncInfo=function(c,a,b,h){return typeof c=="string"&&typeof a=="string"&&typeof b=="string"?!h||typeof h=="object"?{database:c,design:a,view:b,query:h||{}}:false:false};this.onSync=function(){var c=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+c.database+"/_design/"+c.design+"/"+c.view,query:c.query},function(a){var b=JSON.parse(a);if(b.rows){this.reset(b.rows);
if(typeof b.total_rows=="undefined")c.reducedView=true;this.getStateMachine().event("listen");this.getPromise().fulfill(b)}else throw Error("CouchDBStore ["+c.database+", "+c.design+", "+c.view+"].sync() failed: "+a);},this)};this.onListen=function(){var c=this.getSyncInfo();f.mixin({feed:"continuous",heartbeat:2E4,descending:true},c.query);this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+c.database+"/_changes",query:c.query},function(a){if(a=="\n")return false;var a=
JSON.parse(a),b;b=c.reducedView?"updateReduced":a.deleted?"remove":a.changes&&a.changes[0].rev.search("1-")==0?"add":"change";this.getStateMachine().event(b,a.id)},this)};this.onChange=function(c){var a=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){a=JSON.parse(a);a.rows.length==this.getNbItems()?a.rows.some(function(a,b){a.id==c&&this.set(b,a)},this):this.evenDocsInStore.call(this,
a.rows,c)},this)};this.evenDocsInStore=function(c,a){var b=this.getNbItems();c.length<b?this.loop(function(b,c){b.id==a&&this.del(c)},this):c.length>b&&c.some(function(b,c){if(b.id==a)return this.alter("splice",c,0,b)},this)};this.onAdd=function(c){var a=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){JSON.parse(a).rows.some(function(a,b){a.id==c&&this.alter("splice",b,0,a)},this)},this)};
this.onRemove=function(c){this.loop(function(a,b){a.id==c&&this.del(b)},this)};this.updateReduced=function(){var c=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+c.database+"/_design/"+c.design+"/"+c.view,query:c.query},function(a){this.set(0,JSON.parse(a).rows[0])},this)};this.setStateMachine(new e("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["unsync",
this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["updateReduced",this.updateReduced,this]]}))}return function(c){d.prototype=new g(c);return new d}});
define("CouchDBBulkDocuments",["Store","CouchDBBase","Tools","Promise","StateMachine"],function(i,g,f,e,d){function c(){this.setSyncInfo=function(a,b){if(typeof a=="string"&&typeof b=="object"){var c={database:a,query:b||{}};if(Array.isArray(c.query.keys))c.keys=c.query.keys,delete c.query.keys;return c}else return false};this.onSync=function(){var a=this.getSyncInfo(),b={path:"/"+a.database+"/_all_docs",query:a.query},c;Array.isArray(a.keys)?(b.method="POST",b.data=JSON.stringify({keys:a.keys}),
b.headers={"Content-Type":"application/json"},c=b.data):(b.method="GET",c=JSON.stringify(a.query));a.query.include_docs=true;this.getTransport().request(this.getHandlerName(),b,function(b){var d=JSON.parse(b);if(d.rows)this.reset(d.rows),this.getStateMachine().event("listen"),this.getPromise().fulfill(this);else throw Error('CouchDBBulkDocuments.sync("'+a.database+'", '+c+") failed: "+b);},this)};this.onListen=function(){var a=this.getSyncInfo();f.mixin({feed:"continuous",heartbeat:2E4,descending:true,
include_docs:true},a.query);this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+a.database+"/_changes",query:a.query},function(a){if(a=="\n")return false;var a=JSON.parse(a),c;c=a.changes[0].rev.search("1-")==0?"add":a.deleted?"remove":"change";this.getStateMachine().event(c,a.id,a.doc)},this)};this.onAdd=function(a){var b=this.getSyncInfo();if(b.query.startkey||b.query.endkey)b.query.include_docs=true,b.query.update_seq=true,this.getTransport().request(this.getHandlerName(),
{method:"GET",path:"/"+b.database+"/_all_docs",query:b.query},function(b){JSON.parse(b).rows.forEach(function(b,c){b.id==a&&this.alter("splice",c,0,b.doc)},this)},this);else return false};this.onChange=function(a,b){this.loop(function(c,d){c.id==a&&this.set(d,b)},this)};this.onRemove=function(a){this.loop(function(b,c){b.id==a&&this.del(c)},this)};this.databaseUpdate=function(a){var b=[],c=this.getSyncInfo();this.loop(function(a){b.push(a.doc)});this.getTransport().request(this.getHandlerName(),{method:"POST",
path:"/"+c.database+"/_bulk_docs",headers:{"Content-Type":"application/json"},data:JSON.stringify({docs:b})},function(b){var c=JSON.parse(b);this.loop(function(a,b){if(c[b].ok)a.doc._rev=c[b].rev});a.fulfill(c)},this)};this.upload=function(){var a=new e;this.getStateMachine().event("upload",a);return a};this.setStateMachine(new d("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["unsync",
this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this]]}))}return function(a){c.prototype=new g(a);return new c}});
define("CouchDBUser",["CouchDBDocument","Promise"],function(i,g){function f(){var e="_users",d="org.couchdb.user:";this.getUserDB=function(){return e};this.setUserDB=function(c){return c?(e=c,true):false};this.getIdPrefix=function(){return d};this.setIdPrefix=function(c){return c?(d=c,true):false};this.setId=function(c){return c?(this.set("_id",d+c),true):false};this.getId=function(){return this.get("_id")};this.load=function(c){return this.sync(e,d+c)};this.login=function(){var c=new g,a=this.get("name"),
b=this.get("password");a&&typeof a=="string"&&typeof b=="string"?this.getTransport().request("CouchDB",{method:"GET",path:"/_users/org.couchdb.user:"+a,auth:a+":"+b},c.fulfill,c):c.reject({error:"name & password must be strings"});return c};this.create=function(){var c=new g;this.get("type")||this.set("type","user");this.get("roles")||this.set("roles",[]);this.load(this.get("name")).then(function(){c.reject({error:"Failed to create user. The user already exists"})},function(){this.upload().then(function(a){c.fulfill(a)},
function(a){c.reject(a)})},this);return c}}return function(){f.prototype=new i;return new f}});define("CouchDBSecurity",["CouchDBDocument"],function(i){function g(){var f="_security";this.setName=function(e){return e?(f=e,true):false};this.getName=function(){return f};this.load=function(e){return this.sync(e,f)}}return function(){g.prototype=new i;return new g}});
