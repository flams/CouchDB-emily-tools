/*
 https://github.com/flams/CouchDB-emily-tools
 The MIT License (MIT)
 Copyright (c) 2012 Olivier Scherrer <pode.fr@gmail.com>
*/
define("CouchDBBase",["Store","Tools","Promise"],function(j,h,f){function e(){var c=null,b="CouchDB",a=null,k,d=new f;this.setPromise=function(a){return typeof a=="object"&&typeof a.fulfill=="function"&&typeof a.reject=="function"&&typeof a.then=="function"?(d=a,true):false};this.getPromise=function(){return d};this.getStateMachine=function(){return c};this.setStateMachine=function(a){return typeof a=="object"&&typeof a.event=="function"?(c=a,true):false};this.getTransport=function(){return a};this.setTransport=
function(b){return typeof b=="object"&&typeof b.request=="function"&&typeof b.listen=="function"?(a=b,true):false};this.getHandlerName=function(){return b};this.setHandlerName=function(a){return typeof a=="string"?(b=a,true):false};this.sync=function(){return(k=this.setSyncInfo.apply(this,arguments))?(c.event("sync"),d):false};this.unsync=function(){return c.event("unsync")};this.getSyncInfo=function(){return k};this.onSync=function(){};this.onListen=function(){};this.unsync=function(){this.stopListening();
delete this.stopListening};this.onChange=function(){};this.onAdd=function(){};this.onRemove=function(){};this.setSyncInfo=function(a){return k=a}}return function(c){e.prototype=new j(c);return new e}});
define("CouchDBDocument",["Store","CouchDBBase","Tools","Promise","StateMachine"],function(j,h,f,e,c){function b(){this.setSyncInfo=function(a,b,d){return typeof a=="string"&&typeof b=="string"?!d||typeof d=="object"?{database:a,document:b,query:d||{}}:false:false};this.onSync=function(){var a=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+a.database+"/"+a.document,query:a.query},function(a){var b=JSON.parse(a);b._id?(this.reset(b),this.getPromise().fulfill(this),
this.getStateMachine().event("onListen")):this.getPromise().reject(a)},this)};this.onListen=function(){var a=this.getSyncInfo();this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+a.database+"/_changes",query:{feed:"continuous",heartbeat:2E4,descending:true}},function(b){if(b=="\n")return false;b=JSON.parse(b);b.id==a.document&&b.changes.pop().rev!=this.get("_rev")&&(b.deleted?this.getStateMachine().event("remove"):this.getStateMachine().event("change"))},this)};this.onChange=
function(){var a=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+a.database+"/"+a.document},function(a){this.reset(JSON.parse(a))},this)};this.onRemove=function(){this.reset({})};this.upload=function(){var a=new e;return this.getSyncInfo().document?(this.getStateMachine().event("upload",a),a):false};this.remove=function(){return this.getSyncInfo().document?this.getStateMachine().event("removeFromDatabase"):false};this.databaseCreate=function(a){var b=this.getSyncInfo();
this.getTransport().request(this.getHandlerName(),{method:"PUT",path:"/"+b.database+"/"+b.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(b){b=JSON.parse(b);b.ok?(a.fulfill(b),this.getStateMachine().event("subscribeToDocumentChanges")):a.reject(b)},this)};this.databaseUpdate=function(a){var b=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"PUT",path:"/"+b.database+"/"+b.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},
function(b){b=JSON.parse(b);b.ok?(this.set("_rev",b.rev),a.fulfill(b)):a.reject(b)},this)};this.databaseRemove=function(){var a=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"DELETE",path:"/"+a.database+"/"+a.document,query:{rev:this.get("_rev")}})};this.setStateMachine(new c("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"],["upload",this.databaseCreate,this]],Listening:[["unsync",
this.unsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this],["removeFromDatabase",this.databaseRemove,this]]}))}return function(a){b.prototype=new h(a);return new b}});
define("CouchDBView",["Store","CouchDBBase","Tools"],function(j,h,f){function e(){this.setSyncInfo=function(c,b,a,k){return typeof c=="string"&&typeof b=="string"&&typeof a=="string"?!k||typeof k=="object"?{database:c,design:b,view:a,query:k||{}}:false:false};this.onSync=function(){var c=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+c.database+"/_design/"+c.design+"/"+c.view,query:c.query},function(b){var a=JSON.parse(b);if(a.rows){this.reset(a.rows);
this.getPromise().fulfill(this);if(typeof a.total_rows=="undefined")c.reducedView=true;this.getStateMachine().event("listen")}else throw Error("CouchDBStore ["+c.database+", "+c.design+", "+c.view+"].sync() failed: "+b);},this)};this.onListen=function(){var c=this.getSyncInfo();f.mixin({feed:"continuous",heartbeat:2E4,descending:true},c.query);this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+c.database+"/_changes",query:c.query},function(b){if(b=="\n")return false;var b=
JSON.parse(b),a;a=c.reducedView?"updateReduced":b.deleted?"delete":b.changes&&b.changes[0].rev.search("1-")==0?"add":"change";this.getStateMachine().event(a,b.id)},this)};this.onChange=function(c){var b=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+b.database+"/_design/"+b.design+"/"+b.view,query:b.query},function(a){a=JSON.parse(a);a.rows.length==this.getNbItems()?a.rows.some(function(a,b){a.id==c&&this.set(b,a)},this):this.evenDocsInStore.call(this,
a.rows,c)},this)};this.evenDocsInStore=function(c,b){var a=this.getNbItems();c.length<a?this.loop(function(a,c){a.id==b&&this.del(c)},this):c.length>a&&c.some(function(a,c){if(a.id==b)return this.alter("splice",c,0,a)},this)};this.onAdd=function(c){var b=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+b.database+"/_design/"+b.design+"/"+b.view,query:b.query},function(a){JSON.parse(a).rows.some(function(a,b){a.id==c&&this.alter("splice",b,0,a)},this)},this)};
this.onRemove=function(c){this.loop(function(b,a){b.id==c&&this.del(a)},this)};this.updateReduced=function(){var c=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+c.database+"/_design/"+c.design+"/"+c.view,query:c.query},function(b){this.set(0,JSON.parse(b).rows[0])},this)};this.getStateMachine().get("Listening").add("updateReduced",this.updateReduced,this)}return function(c){e.prototype=new h(c);return new e}});
define("CouchDBBulkDocuments",["Store","CouchDBBase","Tools","Promise"],function(j,h,f,e){function c(){this.setSyncInfo=function(b,a){if(typeof b=="string"&&typeof a=="object"){var c={database:b,query:a||{}};if(Array.isArray(c.query.keys))c.keys=c.query.keys,delete c.query.keys;return c}else return false};this.onSync=function(){var b=this.getSyncInfo(),a={path:"/"+b.database+"/_all_docs",query:b.query},c;Array.isArray(b.keys)?(a.method="POST",a.data=JSON.stringify({keys:b.keys}),a.headers={"Content-Type":"application/json"},
c=a.data):(a.method="GET",c=JSON.stringify(b.query));b.query.include_docs=true;this.getTransport().request(this.getHandlerName(),a,function(a){var e=JSON.parse(a);if(e.rows)this.reset(e.rows),this.getPromise().fulfill(this),this.getStateMachine().event("listen");else throw Error('CouchDBBulkDocuments.sync("'+b.database+'", '+c+") failed: "+a);},this)};this.onListen=function(){var b=this.getSyncInfo();f.mixin({feed:"continuous",heartbeat:2E4,descending:true,include_docs:true},b.query);this.stopListening=
this.getTransport().listen(this.getHandlerName(),{path:"/"+b.database+"/_changes",query:b.query},function(a){if(a=="\n")return false;var a=JSON.parse(a),b;b=a.changes[0].rev.search("1-")==0?"add":a.deleted?"remove":"change";this.getStateMachine().event(b,a.id,a.doc)},this)};this.onAdd=function(b){var a=this.getSyncInfo();if(a.query.startkey||a.query.endkey)a.query.include_docs=true,a.query.update_seq=true,this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+a.database+"/_all_docs",
query:a.query},function(a){JSON.parse(a).rows.forEach(function(a,c){a.id==b&&this.alter("splice",c,0,a.doc)},this)},this);else return false};this.onChange=function(b,a){this.loop(function(c,d){c.id==b&&this.set(d,a)},this)};this.onRemove=function(b){this.loop(function(a,c){a.id==b&&this.del(c)},this)};this.databaseUpdate=function(b){var a=[],c=this.getSyncInfo();this.loop(function(b){a.push(b.doc)});this.getTransport().request(this.getHandlerName(),{method:"POST",path:"/"+c.database+"/_bulk_docs",
headers:{"Content-Type":"application/json"},data:JSON.stringify({docs:a})},function(a){b.fulfill(JSON.parse(a))})};this.upload=function(){var b=new e;this.getStateMachine().event("upload",b);return b};this.getStateMachine().get("Listening").add("upload",this.databaseUpdate,this)}return function(b){c.prototype=new h(b);return new c}});
define("CouchDBStore",["Store","StateMachine","Tools","Promise"],function(j,h,f,e){function c(){var b=null,a={},c=new e,d={getView:function(){a.query=a.query||{};b.request("CouchDB",{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(b){var l=JSON.parse(b);if(l.rows)this.reset(l.rows),c.fulfill(this),typeof l.total_rows=="undefined"&&this.setReducedViewInfo(true),g.event("subscribeToViewChanges");else throw Error("CouchDBStore ["+a.database+", "+a.design+", "+
a.view+"].sync() failed: "+b);},this)},getDocument:function(){b.request("CouchDB",{method:"GET",path:"/"+a.database+"/"+a.document,query:a.query},function(a){var b=JSON.parse(a);b._id?(this.reset(b),c.fulfill(this),g.event("subscribeToDocumentChanges")):c.reject(a)},this)},getBulkDocuments:function(){var i={path:"/"+a.database+"/_all_docs",query:a.query},l;a.keys instanceof Array?(i.method="POST",i.data=JSON.stringify({keys:a.keys}),i.headers={"Content-Type":"application/json"},l=i.data):(i.method=
"GET",l=JSON.stringify(a.query));a.query.include_docs=true;b.request("CouchDB",i,function(b){var i=JSON.parse(b);if(i.rows)this.reset(i.rows),c.fulfill(this),g.event("subscribeToBulkChanges");else throw Error('CouchDBStore.sync("'+a.database+'", '+l+") failed: "+b);},this)},createDocument:function(i){b.request("CouchDB",{method:"PUT",path:"/"+a.database+"/"+a.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(a){a=JSON.parse(a);a.ok?(i.fulfill(a),g.event("subscribeToDocumentChanges")):
i.reject(a)})},subscribeToViewChanges:function(){f.mixin({feed:"continuous",heartbeat:2E4,descending:true},a.query);this.stopListening=b.listen("CouchDB",{path:"/"+a.database+"/_changes",query:a.query},function(b){if(b=="\n")return false;var b=JSON.parse(b),c;c=a.reducedView?"updateReduced":b.deleted?"delete":b.changes&&b.changes[0].rev.search("1-")==0?"add":"change";g.event(c,b.id)},this)},subscribeToDocumentChanges:function(){this.stopListening=b.listen("CouchDB",{path:"/"+a.database+"/_changes",
query:{feed:"continuous",heartbeat:2E4,descending:true}},function(b){if(b=="\n")return false;b=JSON.parse(b);b.id==a.document&&b.changes.pop().rev!=this.get("_rev")&&(b.deleted?g.event("deleteDoc"):g.event("updateDoc"))},this)},subscribeToBulkChanges:function(){f.mixin({feed:"continuous",heartbeat:2E4,descending:true,include_docs:true},a.query);this.stopListening=b.listen("CouchDB",{path:"/"+a.database+"/_changes",query:a.query},function(a){if(a=="\n")return false;var a=JSON.parse(a),b;b=a.changes[0].rev.search("1-")==
0?"bulkAdd":a.deleted?"delete":"bulkChange";g.event(b,a.id,a.doc)},this)},updateDocInStore:function(c){b.request("CouchDB",{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){a=JSON.parse(a);a.rows.length==this.getNbItems()?a.rows.some(function(a,b){a.id==c&&this.set(b,a)},this):this.actions.evenDocsInStore.call(this,a.rows,c)},this)},evenDocsInStore:function(a,b){var c=this.getNbItems();a.length<c?this.loop(function(a,c){a.id==b&&this.del(c)},this):a.length>
c&&a.some(function(a,c){if(a.id==b)return this.alter("splice",c,0,a)},this)},addBulkDocInStore:function(c){if(a.query.startkey||a.query.endkey)a.query.include_docs=true,a.query.update_seq=true,b.request("CouchDB",{method:"GET",path:"/"+a.database+"/_all_docs",query:a.query},function(a){JSON.parse(a).rows.forEach(function(a,b){a.id==c&&this.alter("splice",b,0,a.doc)},this)},this);else return false},updateBulkDocInStore:function(a,b){this.loop(function(c,d){c.id==a&&this.set(d,b)},this)},removeDocInStore:function(a){this.loop(function(b,
c){b.id==a&&this.del(c)},this)},addDocInStore:function(c){b.request("CouchDB",{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){JSON.parse(a).rows.some(function(a,b){a.id==c&&this.alter("splice",b,0,a)},this)},this)},updateReduced:function(){b.request("CouchDB",{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){this.set(0,JSON.parse(a).rows[0])},this)},updateDoc:function(){b.request("CouchDB",{method:"GET",path:"/"+
a.database+"/"+a.document},function(a){this.reset(JSON.parse(a))},this)},deleteDoc:function(){this.reset({})},updateDatabase:function(c){b.request("CouchDB",{method:"PUT",path:"/"+a.database+"/"+a.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(a){a=JSON.parse(a);a.ok?(this.set("_rev",a.rev),c.fulfill(a)):c.reject(a)},this)},updateDatabaseWithBulkDoc:function(c){var d=[];this.loop(function(a){d.push(a.doc)});b.request("CouchDB",{method:"POST",path:"/"+a.database+
"/_bulk_docs",headers:{"Content-Type":"application/json"},data:JSON.stringify({docs:d})},function(a){c.fulfill(JSON.parse(a))})},removeFromDatabase:function(){b.request("CouchDB",{method:"DELETE",path:"/"+a.database+"/"+a.document,query:{rev:this.get("_rev")}})},unsync:function(){this.stopListening();delete this.stopListening}},g=new h("Unsynched",{Unsynched:[["getView",d.getView,this,"Synched"],["getDocument",d.getDocument,this,"Synched"],["getBulkDocuments",d.getBulkDocuments,this,"Synched"]],Synched:[["updateDatabase",
d.createDocument,this],["subscribeToViewChanges",d.subscribeToViewChanges,this,"Listening"],["subscribeToDocumentChanges",d.subscribeToDocumentChanges,this,"Listening"],["subscribeToBulkChanges",d.subscribeToBulkChanges,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["change",d.updateDocInStore,this],["bulkAdd",d.addBulkDocInStore,this],["bulkChange",d.updateBulkDocInStore,this],["delete",d.removeDocInStore,this],["add",d.addDocInStore,this],["updateReduced",d.updateReduced,this],
["updateDoc",d.updateDoc,this],["deleteDoc",d.deleteDoc,this],["updateDatabase",d.updateDatabase,this],["updateDatabaseWithBulkDoc",d.updateDatabaseWithBulkDoc,this],["removeFromDatabase",d.removeFromDatabase,this],["unsync",d.unsync,this,"Unsynched"]]});this.sync=function(a,b,d,f){c=new e;if(typeof a=="string"&&typeof b=="string"&&typeof d=="string")return this.setSyncInfo(a,b,d,f),g.event("getView"),c;else if(typeof a=="string"&&typeof b=="string"&&typeof d!="string")return this.setSyncInfo(a,b,
d),g.event("getDocument"),c;else if(typeof a=="string"&&b instanceof Object)return this.setSyncInfo(a,b),g.event("getBulkDocuments"),c;return false};this.setSyncInfo=function(b,c,d,e){this.clearSyncInfo();if(typeof b=="string"&&typeof c=="string"&&typeof d=="string")return a.database=b,a.design=c,a.view=d,a.query=e,true;else if(typeof b=="string"&&typeof c=="string"&&typeof d!="string")return a.database=b,a.document=c,a.query=d,true;else if(typeof b=="string"&&c instanceof Object){a.database=b;a.query=
c;if(a.query.keys instanceof Array)a.keys=a.query.keys,delete a.query.keys;return true}return false};this.clearSyncInfo=function(){a={};return true};this.setReducedViewInfo=function(b){return typeof b=="boolean"?(a.reducedView=b,true):false};this.getSyncInfo=function(){return a};this.unsync=function(){return g.event("unsync")};this.upload=function(){var b=new e;if(a.document)return g.event("updateDatabase",b),b;else if(!a.view)return g.event("updateDatabaseWithBulkDoc",b),b;return false};this.remove=
function(){return a.document?g.event("removeFromDatabase"):false};this.setTransport=function(a){return a&&typeof a.listen=="function"&&typeof a.request=="function"?(b=a,true):false};this.getStateMachine=function(){return g};this.getTransport=function(){return b};this.actions=d}return function(b){c.prototype=new j(b);return new c}});
define("CouchDBUser",["CouchDBStore","Promise"],function(j,h){function f(){var e="_users",c="org.couchdb.user:";this.getUserDB=function(){return e};this.setUserDB=function(b){return b?(e=b,true):false};this.getIdPrefix=function(){return c};this.setIdPrefix=function(b){return b?(c=b,true):false};this.setId=function(b){return b?(this.set("_id",c+b),true):false};this.getId=function(){return this.get("_id")};this.load=function(b){return this.sync(e,c+b)};this.login=function(){var b=new h,a=this.get("name"),
c=this.get("password");a&&typeof a=="string"&&typeof c=="string"?this.getTransport().request("CouchDB",{method:"GET",path:"/_users/org.couchdb.user:"+a,auth:a+":"+c},b.fulfill,b):b.reject({error:"name & password must be strings"});return b};this.create=function(){var b=new h;this.get("type")||this.set("type","user");this.get("roles")||this.set("roles",[]);this.load(this.get("name")).then(function(){b.reject({error:"Failed to create user. The user already exists"})},function(){this.upload().then(function(a){b.fulfill(a)},
function(a){b.reject(a)})},this);return b}}return function(){f.prototype=new j;return new f}});define("CouchDBSecurity",["CouchDBStore"],function(j){function h(){var f="_security";this.setName=function(e){return e?(f=e,true):false};this.getName=function(){return f};this.load=function(e){return this.sync(e,f)}}return function(){h.prototype=new j;return new h}});
