require=function e$$0(f,e,h){function g(a,d){if(!e[a]){if(!f[a]){var b=typeof require=="function"&&require;if(!d&&b)return b(a,true);if(i)return i(a,true);throw Error("Cannot find module '"+a+"'");}b=e[a]={exports:{}};f[a][0].call(b.exports,function(d){var b=f[a][1][d];return g(b?b:d)},b,b.exports,e$$0,f,e,h)}return e[a].exports}for(var i=typeof require=="function"&&require,b=0;b<h.length;b++)g(h[b]);return g}({1:[function(c,f){function e(){var c=null,b="CouchDB",a=null,d,j=new g;this.setPromise=
function(a){return typeof a=="object"&&typeof a.fulfill=="function"&&typeof a.reject=="function"&&typeof a.then=="function"?(j=a,true):false};this.getPromise=function(){return j};this.getStateMachine=function(){return c};this.setStateMachine=function(a){return typeof a=="object"&&typeof a.event=="function"?(c=a,true):false};this.getTransport=function(){return a};this.setTransport=function(d){return typeof d=="object"&&typeof d.request=="function"&&typeof d.listen=="function"?(a=d,true):false};this.getHandlerName=
function(){return b};this.setHandlerName=function(a){return typeof a=="string"?(b=a,true):false};this.sync=function(){j=new g;return this.setSyncInfo.apply(this,arguments)?(c.event("sync"),j):false};this.unsync=function(){return c.event("unsync")};this.getSyncInfo=function(){return d};this.onSync=function(){};this.onListen=function(){};this.onUnsync=function(){this.stopListening&&(this.stopListening(),delete this.stopListening)};this.unsync=function(){c.event("unsync")};this.onChange=function(){};
this.onAdd=function(){};this.onRemove=function(){};this.setSyncInfo=function(a){return d=a}}var h=c("emily").Store,g=c("emily").Promise;f.exports=function(c){e.prototype=new h(c);return new e}},{}],2:[function(c,f){function e(){this.setSyncInfo=function(a,d){if(typeof a=="string"&&typeof d=="object"){var b={database:a,query:d||{}};if(Array.isArray(b.query.keys))b.keys=b.query.keys,delete b.query.keys;return b}else return false};this.onSync=function(){var a=this.getSyncInfo(),d={path:"/"+a.database+
"/_all_docs",query:a.query},b;Array.isArray(a.keys)?(d.method="POST",d.data=JSON.stringify({keys:a.keys}),d.headers={"Content-Type":"application/json"},b=d.data):(d.method="GET",b=JSON.stringify(a.query));a.query.include_docs=true;this.getTransport().request(this.getHandlerName(),d,function(d){var c=JSON.parse(d);if(c.rows)this.reset(c.rows),this.getStateMachine().event("listen"),this.getPromise().fulfill(this);else throw Error('CouchDBBulkDocuments.sync("'+a.database+'", '+b+") failed: "+d);},this)};
this.onListen=function(){var a=this.getSyncInfo();g.mixin({feed:"continuous",heartbeat:2E4,descending:true,include_docs:true},a.query);this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+a.database+"/_changes",query:a.query},function(a){var b;if(a=="\n")return false;a=JSON.parse(a);b=a.changes[0].rev.search("1-")===0?"add":a.deleted?"remove":"change";this.getStateMachine().event(b,a.id,a.doc)},this)};this.onAdd=function(a){var b=this.getSyncInfo();if(b.query.startkey||b.query.endkey)b.query.include_docs=
true,b.query.update_seq=true,this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+b.database+"/_all_docs",query:b.query},function(b){JSON.parse(b).rows.forEach(function(b,d){b.id==a&&this.alter("splice",d,0,b.doc)},this)},this);else return false};this.onChange=function(a,b){this.loop(function(c,e){c.id==a&&this.set(e,b)},this)};this.onRemove=function(a){this.loop(function(b,c){b.id==a&&this.del(c)},this)};this.databaseUpdate=function(a){var b=[],c=this.getSyncInfo();this.loop(function(a){b.push(a.doc)});
this.getTransport().request(this.getHandlerName(),{method:"POST",path:"/"+c.database+"/_bulk_docs",headers:{"Content-Type":"application/json"},data:JSON.stringify({docs:b})},function(b){var d=JSON.parse(b);this.loop(function(a,b){if(d[b].ok)a.doc._rev=d[b].rev});a.fulfill(d)},this)};this.upload=function(){var a=new i;this.getStateMachine().event("upload",a);return a};this.setStateMachine(new b("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],
["unsync",function(){},"Unsynched"]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this]]}))}var h=c("./CouchDBBase"),g=c("emily").Tools,i=c("emily").Promise,b=c("emily").StateMachine;f.exports=function(a){e.prototype=new h(a);return new e}},{"./CouchDBBase":1}],3:[function(c,f){function e(){this.setSyncInfo=function(b,a,d){return typeof b=="string"&&typeof a=="string"?!d||typeof d==
"object"?{database:b,document:a,query:d||{}}:false:false};this.onSync=function(){var b=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+b.database+"/"+b.document,query:b.query},function(a){a=JSON.parse(a);a._id&&(this.reset(a),this.getStateMachine().event("listen"));this.getPromise().fulfill(a)},this)};this.onListen=function(){var b=this.getSyncInfo();this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+b.database+"/_changes",query:{feed:"continuous",
heartbeat:2E4,descending:true}},function(a){if(a=="\n")return false;a=JSON.parse(a);a.id==b.document&&a.changes.pop().rev!=this.get("_rev")&&(a.deleted?this.getStateMachine().event("remove"):this.getStateMachine().event("change"))},this)};this.onChange=function(){var b=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+b.database+"/"+b.document},function(a){this.reset(JSON.parse(a))},this)};this.onRemove=function(){this.reset({})};this.upload=function(){var b=
new g;return this.getSyncInfo().document?(this.getStateMachine().event("upload",b),b):false};this.remove=function(){var b=new g;this.getStateMachine().event("removeFromDatabase",b);return b};this.databaseCreate=function(b){var a=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"PUT",path:"/"+a.database+"/"+a.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(a){a=JSON.parse(a);a.ok?(this.set("_rev",a.rev),this.set("_id",a.id),this.getStateMachine().event("listen"),
b.fulfill(a)):b.reject(a)},this)};this.databaseUpdate=function(b){var a=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"PUT",path:"/"+a.database+"/"+a.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(a){a=JSON.parse(a);a.ok?(this.set("_rev",a.rev),b.fulfill(a)):b.reject(a)},this)};this.databaseRemove=function(b){var a=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"DELETE",path:"/"+a.database+"/"+a.document,
query:{rev:this.get("_rev")}},function(a){a=JSON.parse(a);a.ok?b.fulfill(a):b.reject(a)})};this.setStateMachine(new i("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"],["upload",this.databaseCreate,this]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this],["removeFromDatabase",this.databaseRemove,
this]]}))}var h=c("./CouchDBBase"),g=c("emily").Promise,i=c("emily").StateMachine;f.exports=function(b){e.prototype=new h(b);return new e}},{"./CouchDBBase":1}],4:[function(c,f){function e(){var c="_security";this.setName=function(e){return e?(c=e,true):false};this.getName=function(){return c};this.load=function(e){return this.sync(e,c)}}var h=c("./CouchDBDocument");f.exports=function(){e.prototype=new h;return new e}},{"./CouchDBDocument":3}],fjvByQ:[function(c,f){f.exports={CouchDBBulkDocuments:c("./CouchDBBulkDocuments"),
CouchDBDocument:c("./CouchDBDocument"),CouchDBView:c("./CouchDBView"),CouchDBSecurity:c("./CouchDBSecurity"),CouchDBUser:c("./CouchDBUser")}},{"./CouchDBBulkDocuments":2,"./CouchDBDocument":3,"./CouchDBSecurity":4,"./CouchDBUser":7,"./CouchDBView":8}],CouchDBTools:[function(c,f){f.exports=c("fjvByQ")},{}],7:[function(c,f){function e(){var c="_users",b="org.couchdb.user:";this.getUserDB=function(){return c};this.setUserDB=function(a){return a?(c=a,true):false};this.getIdPrefix=function(){return b};
this.setIdPrefix=function(a){return a?(b=a,true):false};this.setId=function(a){return a?(this.set("_id",b+a),true):false};this.getId=function(){return this.get("_id")};this.load=function(a){return this.sync(c,b+a)};this.login=function(){var a=new g,b=this.get("name"),c=this.get("password");b&&typeof b=="string"&&typeof c=="string"?this.getTransport().request("CouchDB",{method:"GET",path:"/_users/org.couchdb.user:"+b,auth:b+":"+c},a.fulfill,a):a.reject({error:"name & password must be strings"});return a};
this.create=function(){var a=new g;this.get("type")||this.set("type","user");this.get("roles")||this.set("roles",[]);this.load(this.get("name")).then(function(){a.reject({error:"Failed to create user. The user already exists"})},function(){this.upload().then(function(b){a.fulfill(b)},function(b){a.reject(b)})},this);return a}}var h=c("./CouchDBDocument"),g=c("emily").Promise;f.exports=function(){e.prototype=new h;return new e}},{"./CouchDBDocument":3}],8:[function(c,f){function e(){this.setSyncInfo=
function(b,a,d,c){return typeof b=="string"&&typeof a=="string"&&typeof d=="string"?!c||typeof c=="object"?{database:b,design:a,view:d,query:c||{}}:false:false};this.onSync=function(){var b=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+b.database+"/_design/"+b.design+"/"+b.view,query:b.query},function(a){var c=JSON.parse(a);if(c.rows){this.reset(c.rows);if(typeof c.total_rows=="undefined")b.reducedView=true;this.getStateMachine().event("listen");this.getPromise().fulfill(c)}else throw Error("CouchDBStore ["+
b.database+", "+b.design+", "+b.view+"].sync() failed: "+a);},this)};this.onListen=function(){var b=this.getSyncInfo();g.mixin({feed:"continuous",heartbeat:2E4,descending:true},b.query);this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+b.database+"/_changes",query:b.query},function(a){if(a=="\n")return false;var a=JSON.parse(a),c;c=b.reducedView?"updateReduced":a.deleted?"remove":a.changes&&a.changes[0].rev.search("1-")===0?"add":"change";this.getStateMachine().event(c,
a.id)},this)};this.onChange=function(b){var a=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){a=JSON.parse(a);a.rows.length==this.getNbItems()?a.rows.some(function(a,c){a.id==b&&this.set(c,a)},this):this.evenDocsInStore.call(this,a.rows,b)},this)};this.evenDocsInStore=function(b,a){var c=this.getNbItems();b.length<c?this.loop(function(b,c){b.id==a&&this.del(c)},this):b.length>c&&b.some(function(b,
c){if(b.id==a)return this.alter("splice",c,0,b)},this)};this.onAdd=function(b){var a=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){JSON.parse(a).rows.some(function(a,c){a.id==b&&this.alter("splice",c,0,a)},this)},this)};this.onRemove=function(b){this.loop(function(a,c){a.id==b&&this.del(c)},this)};this.updateReduced=function(){var b=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),
{method:"GET",path:"/"+b.database+"/_design/"+b.design+"/"+b.view,query:b.query},function(a){this.set(0,JSON.parse(a).rows[0])},this)};this.setStateMachine(new i("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["updateReduced",this.updateReduced,this]]}))}var h=c("./CouchDBBase"),
g=c("emily").Tools,i=c("emily").StateMachine;f.exports=function(b){e.prototype=new h(b);return new e}},{"./CouchDBBase":1}],9:[function(){},{}]},{},[]);
