/*
 https://github.com/flams/CouchDB-emily-tools
 The MIT License (MIT)
 Copyright (c) 2012 Olivier Scherrer <pode.fr@gmail.com>
*/
define("CouchDBBase",["Store","Tools","Promise"],function(j,i,g){function e(){var e=null,b="CouchDB",a=null,c,d=new g;this.setPromise=function(a){return typeof a=="object"&&typeof a.fulfill=="function"&&typeof a.reject=="function"&&typeof a.then=="function"?(d=a,true):false};this.getPromise=function(){return d};this.getStateMachine=function(){return e};this.setStateMachine=function(a){return typeof a=="object"&&typeof a.event=="function"?(e=a,true):false};this.getTransport=function(){return a};this.setTransport=
function(c){return typeof c=="object"&&typeof c.request=="function"&&typeof c.listen=="function"?(a=c,true):false};this.getHandlerName=function(){return b};this.setHandlerName=function(a){return typeof a=="string"?(b=a,true):false};this.sync=function(){return(c=this.setSyncInfo.apply(this,arguments))?(e.event("sync"),d):false};this.unsync=function(){return e.event("unsync")};this.getSyncInfo=function(){return c};this.onSync=function(){};this.onListen=function(){};this.unsync=function(){this.stopListening();
delete this.stopListening};this.onChange=function(){};this.onAdd=function(){};this.onRemove=function(){};this.setSyncInfo=function(a){return c=a}}return function(g){e.prototype=new j(g);return new e}});
define("CouchDBDocument",["Store","CouchDBBase","Tools","Promise","StateMachine"],function(j,i,g,e,l){function b(){this.setSyncInfo=function(a,c,b){return typeof a=="string"&&typeof c=="string"?!b||typeof b=="object"?{database:a,document:c,query:b||{}}:false:false};this.onSync=function(){var a=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+a.database+"/"+a.document,query:a.query},function(a){var b=JSON.parse(a);b._id?(this.reset(b),this.getPromise().fulfill(this),
this.getStateMachine().event("listen")):this.getPromise().reject(a)},this)};this.onListen=function(){var a=this.getSyncInfo();this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+a.database+"/_changes",query:{feed:"continuous",heartbeat:2E4,descending:true}},function(c){if(c=="\n")return false;c=JSON.parse(c);c.id==a.document&&c.changes.pop().rev!=this.get("_rev")&&(c.deleted?this.getStateMachine().event("remove"):this.getStateMachine().event("change"))},this)};this.onChange=
function(){var a=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+a.database+"/"+a.document},function(a){this.reset(JSON.parse(a))},this)};this.onRemove=function(){this.reset({})};this.upload=function(){var a=new e;return this.getSyncInfo().document?(this.getStateMachine().event("upload",a),a):false};this.remove=function(){return this.getSyncInfo().document?this.getStateMachine().event("removeFromDatabase"):false};this.databaseCreate=function(a){var b=this.getSyncInfo();
this.getTransport().request(this.getHandlerName(),{method:"PUT",path:"/"+b.database+"/"+b.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(b){b=JSON.parse(b);b.ok?(a.fulfill(b),this.getStateMachine().event("subscribeToDocumentChanges")):a.reject(b)},this)};this.databaseUpdate=function(a){var b=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"PUT",path:"/"+b.database+"/"+b.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},
function(b){b=JSON.parse(b);b.ok?(this.set("_rev",b.rev),a.fulfill(b)):a.reject(b)},this)};this.databaseRemove=function(){var a=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"DELETE",path:"/"+a.database+"/"+a.document,query:{rev:this.get("_rev")}})};this.setStateMachine(new l("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"],["upload",this.databaseCreate,this]],Listening:[["unsync",
this.unsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this],["removeFromDatabase",this.databaseRemove,this]]}))}return function(a){b.prototype=new i(a);return new b}});
define("CouchDBView",["Store","CouchDBBase","Tools","StateMachine"],function(j,i,g,e){function l(){this.setSyncInfo=function(b,a,c,d){return typeof b=="string"&&typeof a=="string"&&typeof c=="string"?!d||typeof d=="object"?{database:b,design:a,view:c,query:d||{}}:false:false};this.onSync=function(){var b=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+b.database+"/_design/"+b.design+"/"+b.view,query:b.query},function(a){var c=JSON.parse(a);if(c.rows){this.reset(c.rows);
this.getPromise().fulfill(this);if(typeof c.total_rows=="undefined")b.reducedView=true;this.getStateMachine().event("listen")}else throw Error("CouchDBStore ["+b.database+", "+b.design+", "+b.view+"].sync() failed: "+a);},this)};this.onListen=function(){var b=this.getSyncInfo();g.mixin({feed:"continuous",heartbeat:2E4,descending:true},b.query);this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+b.database+"/_changes",query:b.query},function(a){if(a=="\n")return false;var a=
JSON.parse(a),c;c=b.reducedView?"updateReduced":a.deleted?"delete":a.changes&&a.changes[0].rev.search("1-")==0?"add":"change";this.getStateMachine().event(c,a.id)},this)};this.onChange=function(b){var a=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){a=JSON.parse(a);a.rows.length==this.getNbItems()?a.rows.some(function(a,c){a.id==b&&this.set(c,a)},this):this.evenDocsInStore.call(this,
a.rows,b)},this)};this.evenDocsInStore=function(b,a){var c=this.getNbItems();b.length<c?this.loop(function(b,c){b.id==a&&this.del(c)},this):b.length>c&&b.some(function(b,c){if(b.id==a)return this.alter("splice",c,0,b)},this)};this.onAdd=function(b){var a=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){JSON.parse(a).rows.some(function(a,c){a.id==b&&this.alter("splice",c,0,a)},this)},this)};
this.onRemove=function(b){this.loop(function(a,c){a.id==b&&this.del(c)},this)};this.updateReduced=function(){var b=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+b.database+"/_design/"+b.design+"/"+b.view,query:b.query},function(a){this.set(0,JSON.parse(a).rows[0])},this)};this.setStateMachine(new e("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["unsync",
this.unsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["updateReduced",this.updateReduced,this]]}))}return function(b){l.prototype=new i(b);return new l}});
define("CouchDBBulkDocuments",["Store","CouchDBBase","Tools","Promise","StateMachine"],function(j,i,g,e,l){function b(){this.setSyncInfo=function(a,b){if(typeof a=="string"&&typeof b=="object"){var d={database:a,query:b||{}};if(Array.isArray(d.query.keys))d.keys=d.query.keys,delete d.query.keys;return d}else return false};this.onSync=function(){var a=this.getSyncInfo(),b={path:"/"+a.database+"/_all_docs",query:a.query},d;Array.isArray(a.keys)?(b.method="POST",b.data=JSON.stringify({keys:a.keys}),
b.headers={"Content-Type":"application/json"},d=b.data):(b.method="GET",d=JSON.stringify(a.query));a.query.include_docs=true;this.getTransport().request(this.getHandlerName(),b,function(b){var f=JSON.parse(b);if(f.rows)this.reset(f.rows),this.getPromise().fulfill(this),this.getStateMachine().event("listen");else throw Error('CouchDBBulkDocuments.sync("'+a.database+'", '+d+") failed: "+b);},this)};this.onListen=function(){var a=this.getSyncInfo();g.mixin({feed:"continuous",heartbeat:2E4,descending:true,
include_docs:true},a.query);this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+a.database+"/_changes",query:a.query},function(a){if(a=="\n")return false;var a=JSON.parse(a),b;b=a.changes[0].rev.search("1-")==0?"add":a.deleted?"remove":"change";this.getStateMachine().event(b,a.id,a.doc)},this)};this.onAdd=function(a){var b=this.getSyncInfo();if(b.query.startkey||b.query.endkey)b.query.include_docs=true,b.query.update_seq=true,this.getTransport().request(this.getHandlerName(),
{method:"GET",path:"/"+b.database+"/_all_docs",query:b.query},function(b){JSON.parse(b).rows.forEach(function(b,f){b.id==a&&this.alter("splice",f,0,b.doc)},this)},this);else return false};this.onChange=function(a,b){this.loop(function(d,e){d.id==a&&this.set(e,b)},this)};this.onRemove=function(a){this.loop(function(b,d){b.id==a&&this.del(d)},this)};this.databaseUpdate=function(a){var b=[],d=this.getSyncInfo();this.loop(function(a){b.push(a.doc)});this.getTransport().request(this.getHandlerName(),{method:"POST",
path:"/"+d.database+"/_bulk_docs",headers:{"Content-Type":"application/json"},data:JSON.stringify({docs:b})},function(b){a.fulfill(JSON.parse(b))})};this.upload=function(){var a=new e;this.getStateMachine().event("upload",a);return a};this.setStateMachine(new l("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["unsync",this.unsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,
this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this]]}))}return function(a){b.prototype=new i(a);return new b}});
define("CouchDBStore",["Store","StateMachine","Tools","Promise"],function(j,i,g,e){function l(){var b=null,a={},c=new e,d={getView:function(){a.query=a.query||{};b.request("CouchDB",{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(b){var k=JSON.parse(b);if(k.rows)this.reset(k.rows),c.fulfill(this),typeof k.total_rows=="undefined"&&this.setReducedViewInfo(true),h.event("subscribeToViewChanges");else throw Error("CouchDBStore ["+a.database+", "+a.design+", "+
a.view+"].sync() failed: "+b);},this)},getDocument:function(){b.request("CouchDB",{method:"GET",path:"/"+a.database+"/"+a.document,query:a.query},function(a){var b=JSON.parse(a);b._id?(this.reset(b),c.fulfill(this),h.event("subscribeToDocumentChanges")):c.reject(a)},this)},getBulkDocuments:function(){var f={path:"/"+a.database+"/_all_docs",query:a.query},k;a.keys instanceof Array?(f.method="POST",f.data=JSON.stringify({keys:a.keys}),f.headers={"Content-Type":"application/json"},k=f.data):(f.method=
"GET",k=JSON.stringify(a.query));a.query.include_docs=true;b.request("CouchDB",f,function(b){var f=JSON.parse(b);if(f.rows)this.reset(f.rows),c.fulfill(this),h.event("subscribeToBulkChanges");else throw Error('CouchDBStore.sync("'+a.database+'", '+k+") failed: "+b);},this)},createDocument:function(f){b.request("CouchDB",{method:"PUT",path:"/"+a.database+"/"+a.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(a){a=JSON.parse(a);a.ok?(f.fulfill(a),h.event("subscribeToDocumentChanges")):
f.reject(a)})},subscribeToViewChanges:function(){g.mixin({feed:"continuous",heartbeat:2E4,descending:true},a.query);this.stopListening=b.listen("CouchDB",{path:"/"+a.database+"/_changes",query:a.query},function(b){if(b=="\n")return false;var b=JSON.parse(b),k;k=a.reducedView?"updateReduced":b.deleted?"delete":b.changes&&b.changes[0].rev.search("1-")==0?"add":"change";h.event(k,b.id)},this)},subscribeToDocumentChanges:function(){this.stopListening=b.listen("CouchDB",{path:"/"+a.database+"/_changes",
query:{feed:"continuous",heartbeat:2E4,descending:true}},function(b){if(b=="\n")return false;b=JSON.parse(b);b.id==a.document&&b.changes.pop().rev!=this.get("_rev")&&(b.deleted?h.event("deleteDoc"):h.event("updateDoc"))},this)},subscribeToBulkChanges:function(){g.mixin({feed:"continuous",heartbeat:2E4,descending:true,include_docs:true},a.query);this.stopListening=b.listen("CouchDB",{path:"/"+a.database+"/_changes",query:a.query},function(a){if(a=="\n")return false;var a=JSON.parse(a),b;b=a.changes[0].rev.search("1-")==
0?"bulkAdd":a.deleted?"delete":"bulkChange";h.event(b,a.id,a.doc)},this)},updateDocInStore:function(f){b.request("CouchDB",{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){a=JSON.parse(a);a.rows.length==this.getNbItems()?a.rows.some(function(a,b){a.id==f&&this.set(b,a)},this):this.actions.evenDocsInStore.call(this,a.rows,f)},this)},evenDocsInStore:function(a,b){var c=this.getNbItems();a.length<c?this.loop(function(a,f){a.id==b&&this.del(f)},this):a.length>
c&&a.some(function(a,f){if(a.id==b)return this.alter("splice",f,0,a)},this)},addBulkDocInStore:function(f){if(a.query.startkey||a.query.endkey)a.query.include_docs=true,a.query.update_seq=true,b.request("CouchDB",{method:"GET",path:"/"+a.database+"/_all_docs",query:a.query},function(a){JSON.parse(a).rows.forEach(function(a,b){a.id==f&&this.alter("splice",b,0,a.doc)},this)},this);else return false},updateBulkDocInStore:function(a,b){this.loop(function(c,d){c.id==a&&this.set(d,b)},this)},removeDocInStore:function(a){this.loop(function(b,
c){b.id==a&&this.del(c)},this)},addDocInStore:function(f){b.request("CouchDB",{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){JSON.parse(a).rows.some(function(a,b){a.id==f&&this.alter("splice",b,0,a)},this)},this)},updateReduced:function(){b.request("CouchDB",{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){this.set(0,JSON.parse(a).rows[0])},this)},updateDoc:function(){b.request("CouchDB",{method:"GET",path:"/"+
a.database+"/"+a.document},function(a){this.reset(JSON.parse(a))},this)},deleteDoc:function(){this.reset({})},updateDatabase:function(c){b.request("CouchDB",{method:"PUT",path:"/"+a.database+"/"+a.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(a){a=JSON.parse(a);a.ok?(this.set("_rev",a.rev),c.fulfill(a)):c.reject(a)},this)},updateDatabaseWithBulkDoc:function(c){var d=[];this.loop(function(a){d.push(a.doc)});b.request("CouchDB",{method:"POST",path:"/"+a.database+
"/_bulk_docs",headers:{"Content-Type":"application/json"},data:JSON.stringify({docs:d})},function(a){c.fulfill(JSON.parse(a))})},removeFromDatabase:function(){b.request("CouchDB",{method:"DELETE",path:"/"+a.database+"/"+a.document,query:{rev:this.get("_rev")}})},unsync:function(){this.stopListening();delete this.stopListening}},h=new i("Unsynched",{Unsynched:[["getView",d.getView,this,"Synched"],["getDocument",d.getDocument,this,"Synched"],["getBulkDocuments",d.getBulkDocuments,this,"Synched"]],Synched:[["updateDatabase",
d.createDocument,this],["subscribeToViewChanges",d.subscribeToViewChanges,this,"Listening"],["subscribeToDocumentChanges",d.subscribeToDocumentChanges,this,"Listening"],["subscribeToBulkChanges",d.subscribeToBulkChanges,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["change",d.updateDocInStore,this],["bulkAdd",d.addBulkDocInStore,this],["bulkChange",d.updateBulkDocInStore,this],["delete",d.removeDocInStore,this],["add",d.addDocInStore,this],["updateReduced",d.updateReduced,this],
["updateDoc",d.updateDoc,this],["deleteDoc",d.deleteDoc,this],["updateDatabase",d.updateDatabase,this],["updateDatabaseWithBulkDoc",d.updateDatabaseWithBulkDoc,this],["removeFromDatabase",d.removeFromDatabase,this],["unsync",d.unsync,this,"Unsynched"]]});this.sync=function(a,b,d,g){c=new e;if(typeof a=="string"&&typeof b=="string"&&typeof d=="string")return this.setSyncInfo(a,b,d,g),h.event("getView"),c;else if(typeof a=="string"&&typeof b=="string"&&typeof d!="string")return this.setSyncInfo(a,b,
d),h.event("getDocument"),c;else if(typeof a=="string"&&b instanceof Object)return this.setSyncInfo(a,b),h.event("getBulkDocuments"),c;return false};this.setSyncInfo=function(b,c,d,e){this.clearSyncInfo();if(typeof b=="string"&&typeof c=="string"&&typeof d=="string")return a.database=b,a.design=c,a.view=d,a.query=e,true;else if(typeof b=="string"&&typeof c=="string"&&typeof d!="string")return a.database=b,a.document=c,a.query=d,true;else if(typeof b=="string"&&c instanceof Object){a.database=b;a.query=
c;if(a.query.keys instanceof Array)a.keys=a.query.keys,delete a.query.keys;return true}return false};this.clearSyncInfo=function(){a={};return true};this.setReducedViewInfo=function(b){return typeof b=="boolean"?(a.reducedView=b,true):false};this.getSyncInfo=function(){return a};this.unsync=function(){return h.event("unsync")};this.upload=function(){var b=new e;if(a.document)return h.event("updateDatabase",b),b;else if(!a.view)return h.event("updateDatabaseWithBulkDoc",b),b;return false};this.remove=
function(){return a.document?h.event("removeFromDatabase"):false};this.setTransport=function(a){return a&&typeof a.listen=="function"&&typeof a.request=="function"?(b=a,true):false};this.getStateMachine=function(){return h};this.getTransport=function(){return b};this.actions=d}return function(b){l.prototype=new j(b);return new l}});
define("CouchDBUser",["CouchDBStore","Promise"],function(j,i){function g(){var e="_users",g="org.couchdb.user:";this.getUserDB=function(){return e};this.setUserDB=function(b){return b?(e=b,true):false};this.getIdPrefix=function(){return g};this.setIdPrefix=function(b){return b?(g=b,true):false};this.setId=function(b){return b?(this.set("_id",g+b),true):false};this.getId=function(){return this.get("_id")};this.load=function(b){return this.sync(e,g+b)};this.login=function(){var b=new i,a=this.get("name"),
c=this.get("password");a&&typeof a=="string"&&typeof c=="string"?this.getTransport().request("CouchDB",{method:"GET",path:"/_users/org.couchdb.user:"+a,auth:a+":"+c},b.fulfill,b):b.reject({error:"name & password must be strings"});return b};this.create=function(){var b=new i;this.get("type")||this.set("type","user");this.get("roles")||this.set("roles",[]);this.load(this.get("name")).then(function(){b.reject({error:"Failed to create user. The user already exists"})},function(){this.upload().then(function(a){b.fulfill(a)},
function(a){b.reject(a)})},this);return b}}return function(){g.prototype=new j;return new g}});define("CouchDBSecurity",["CouchDBStore"],function(j){function i(){var g="_security";this.setName=function(e){return e?(g=e,true):false};this.getName=function(){return g};this.load=function(e){return this.sync(e,g)}}return function(){i.prototype=new j;return new i}});
