/*
 https://github.com/flams/CouchDB-emily-tools
 The MIT License (MIT)
 Copyright (c) 2012 Olivier Scherrer <pode.fr@gmail.com>
*/
define("CouchDBBase",["Store","StateMachine","Tools","Promise"],function(){});define("CouchDBSecurity",["CouchDBStore"],function(k){function j(){var f="_security";this.setName=function(h){return h?(f=h,true):false};this.getName=function(){return f};this.load=function(h){return this.sync(h,f)}}return function(){j.prototype=new k;return new j}});
define("CouchDBStore",["Store","StateMachine","Tools","Promise"],function(k,j,f,h){function l(){var b=null,a={},i=new h,d={getView:function(){a.query=a.query||{};b.request("CouchDB",{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(c){var e=JSON.parse(c);if(e.rows)this.reset(e.rows),i.fulfill(this),typeof e.total_rows=="undefined"&&this.setReducedViewInfo(true),g.event("subscribeToViewChanges");else throw Error("CouchDBStore ["+a.database+", "+a.design+", "+
a.view+"].sync() failed: "+c);},this)},getDocument:function(){b.request("CouchDB",{method:"GET",path:"/"+a.database+"/"+a.document,query:a.query},function(c){var a=JSON.parse(c);a._id?(this.reset(a),i.fulfill(this),g.event("subscribeToDocumentChanges")):i.reject(c)},this)},getBulkDocuments:function(){var c={path:"/"+a.database+"/_all_docs",query:a.query},e;a.keys instanceof Array?(c.method="POST",c.data=JSON.stringify({keys:a.keys}),c.headers={"Content-Type":"application/json"},e=c.data):(c.method=
"GET",e=JSON.stringify(a.query));a.query.include_docs=true;b.request("CouchDB",c,function(c){var b=JSON.parse(c);if(b.rows)this.reset(b.rows),i.fulfill(this),g.event("subscribeToBulkChanges");else throw Error('CouchDBStore.sync("'+a.database+'", '+e+") failed: "+c);},this)},createDocument:function(c){b.request("CouchDB",{method:"PUT",path:"/"+a.database+"/"+a.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(a){a=JSON.parse(a);a.ok?(c.fulfill(a),g.event("subscribeToDocumentChanges")):
c.reject(a)})},subscribeToViewChanges:function(){f.mixin({feed:"continuous",heartbeat:2E4,descending:true},a.query);this.stopListening=b.listen("CouchDB",{path:"/"+a.database+"/_changes",query:a.query},function(c){if(c=="\n")return false;var c=JSON.parse(c),e;e=a.reducedView?"updateReduced":c.deleted?"delete":c.changes&&c.changes[0].rev.search("1-")==0?"add":"change";g.event(e,c.id)},this)},subscribeToDocumentChanges:function(){this.stopListening=b.listen("CouchDB",{path:"/"+a.database+"/_changes",
query:{feed:"continuous",heartbeat:2E4,descending:true}},function(c){if(c=="\n")return false;c=JSON.parse(c);c.id==a.document&&c.changes.pop().rev!=this.get("_rev")&&(c.deleted?g.event("deleteDoc"):g.event("updateDoc"))},this)},subscribeToBulkChanges:function(){f.mixin({feed:"continuous",heartbeat:2E4,descending:true,include_docs:true},a.query);this.stopListening=b.listen("CouchDB",{path:"/"+a.database+"/_changes",query:a.query},function(a){if(a=="\n")return false;var a=JSON.parse(a),e;e=a.changes[0].rev.search("1-")==
0?"bulkAdd":a.deleted?"delete":"bulkChange";g.event(e,a.id,a.doc)},this)},updateDocInStore:function(c){b.request("CouchDB",{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){a=JSON.parse(a);a.rows.length==this.getNbItems()?a.rows.some(function(a,e){a.id==c&&this.set(e,a)},this):this.actions.evenDocsInStore.call(this,a.rows,c)},this)},evenDocsInStore:function(a,e){var b=this.getNbItems();a.length<b?this.loop(function(a,c){a.id==e&&this.del(c)},this):a.length>
b&&a.some(function(a,c){if(a.id==e)return this.alter("splice",c,0,a)},this)},addBulkDocInStore:function(c){if(a.query.startkey||a.query.endkey)a.query.include_docs=true,a.query.update_seq=true,b.request("CouchDB",{method:"GET",path:"/"+a.database+"/_all_docs",query:a.query},function(a){JSON.parse(a).rows.forEach(function(a,e){a.id==c&&this.alter("splice",e,0,a.doc)},this)},this);else return false},updateBulkDocInStore:function(a,e){this.loop(function(b,d){b.id==a&&this.set(d,e)},this)},removeDocInStore:function(a){this.loop(function(e,
b){e.id==a&&this.del(b)},this)},addDocInStore:function(c){b.request("CouchDB",{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){JSON.parse(a).rows.some(function(a,b){a.id==c&&this.alter("splice",b,0,a)},this)},this)},updateReduced:function(){b.request("CouchDB",{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){this.set(0,JSON.parse(a).rows[0])},this)},updateDoc:function(){b.request("CouchDB",{method:"GET",path:"/"+
a.database+"/"+a.document},function(a){this.reset(JSON.parse(a))},this)},deleteDoc:function(){this.reset({})},updateDatabase:function(c){b.request("CouchDB",{method:"PUT",path:"/"+a.database+"/"+a.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(a){a=JSON.parse(a);a.ok?(this.set("_rev",a.rev),c.fulfill(a)):c.reject(a)},this)},updateDatabaseWithBulkDoc:function(c){var e=[];this.loop(function(a){e.push(a.doc)});b.request("CouchDB",{method:"POST",path:"/"+a.database+
"/_bulk_docs",headers:{"Content-Type":"application/json"},data:JSON.stringify({docs:e})},function(a){c.fulfill(JSON.parse(a))})},removeFromDatabase:function(){b.request("CouchDB",{method:"DELETE",path:"/"+a.database+"/"+a.document,query:{rev:this.get("_rev")}})},unsync:function(){this.stopListening();delete this.stopListening}},g=new j("Unsynched",{Unsynched:[["getView",d.getView,this,"Synched"],["getDocument",d.getDocument,this,"Synched"],["getBulkDocuments",d.getBulkDocuments,this,"Synched"]],Synched:[["updateDatabase",
d.createDocument,this],["subscribeToViewChanges",d.subscribeToViewChanges,this,"Listening"],["subscribeToDocumentChanges",d.subscribeToDocumentChanges,this,"Listening"],["subscribeToBulkChanges",d.subscribeToBulkChanges,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["change",d.updateDocInStore,this],["bulkAdd",d.addBulkDocInStore,this],["bulkChange",d.updateBulkDocInStore,this],["delete",d.removeDocInStore,this],["add",d.addDocInStore,this],["updateReduced",d.updateReduced,this],
["updateDoc",d.updateDoc,this],["deleteDoc",d.deleteDoc,this],["updateDatabase",d.updateDatabase,this],["updateDatabaseWithBulkDoc",d.updateDatabaseWithBulkDoc,this],["removeFromDatabase",d.removeFromDatabase,this],["unsync",d.unsync,this,"Unsynched"]]});this.sync=function(a,b,d,f){i=new h;if(typeof a=="string"&&typeof b=="string"&&typeof d=="string")return this.setSyncInfo(a,b,d,f),g.event("getView"),i;else if(typeof a=="string"&&typeof b=="string"&&typeof d!="string")return this.setSyncInfo(a,b,
d),g.event("getDocument"),i;else if(typeof a=="string"&&b instanceof Object)return this.setSyncInfo(a,b),g.event("getBulkDocuments"),i;return false};this.setSyncInfo=function(c,b,d,g){this.clearSyncInfo();if(typeof c=="string"&&typeof b=="string"&&typeof d=="string")return a.database=c,a.design=b,a.view=d,a.query=g,true;else if(typeof c=="string"&&typeof b=="string"&&typeof d!="string")return a.database=c,a.document=b,a.query=d,true;else if(typeof c=="string"&&b instanceof Object){a.database=c;a.query=
b;if(a.query.keys instanceof Array)a.keys=a.query.keys,delete a.query.keys;return true}return false};this.clearSyncInfo=function(){a={};return true};this.setReducedViewInfo=function(c){return typeof c=="boolean"?(a.reducedView=c,true):false};this.getSyncInfo=function(){return a};this.unsync=function(){return g.event("unsync")};this.upload=function(){var c=new h;if(a.document)return g.event("updateDatabase",c),c;else if(!a.view)return g.event("updateDatabaseWithBulkDoc",c),c;return false};this.remove=
function(){return a.document?g.event("removeFromDatabase"):false};this.setTransport=function(a){return a&&typeof a.listen=="function"&&typeof a.request=="function"?(b=a,true):false};this.getStateMachine=function(){return g};this.getTransport=function(){return b};this.actions=d}return function(b){l.prototype=new k(b);return new l}});
define("CouchDBUser",["CouchDBStore","Promise"],function(k,j){function f(){var h="_users",f="org.couchdb.user:";this.getUserDB=function(){return h};this.setUserDB=function(b){return b?(h=b,true):false};this.getIdPrefix=function(){return f};this.setIdPrefix=function(b){return b?(f=b,true):false};this.setId=function(b){return b?(this.set("_id",f+b),true):false};this.getId=function(){return this.get("_id")};this.load=function(b){return this.sync(h,f+b)};this.login=function(){var b=new j,a=this.get("name"),
f=this.get("password");a&&typeof a=="string"&&typeof f=="string"?this.getTransport().request("CouchDB",{method:"GET",path:"/_users/org.couchdb.user:"+a,auth:a+":"+f},b.fulfill,b):b.reject({error:"name & password must be strings"});return b};this.create=function(){var b=new j;this.get("type")||this.set("type","user");this.get("roles")||this.set("roles",[]);this.load(this.get("name")).then(function(){b.reject({error:"Failed to create user. The user already exists"})},function(){this.upload().then(function(a){b.fulfill(a)},
function(a){b.reject(a)})},this);return b}}return function(){f.prototype=new k;return new f}});
